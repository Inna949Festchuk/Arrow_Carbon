# Архитектура проекта

Документация по архитектуре проекта Arrow_Carbon.

## Общая архитектура

Arrow_Carbon построен на основе Django-фреймворка с использованием микросервисной архитектуры через Docker Compose. Проект разделен на несколько основных компонентов:

```
┌─────────────────────────────────────────────────────────────┐
│                      Клиент (Браузер)                        │
└──────────────────────────┬──────────────────────────────────┘
                           │
                           ▼
┌─────────────────────────────────────────────────────────────┐
│                    Django Web Server                        │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐    │
│  │   REST API    │  │  Admin Panel │  │   Static     │    │
│  │  (DRF)        │  │              │  │   Files      │    │
│  └──────────────┘  └──────────────┘  └──────────────┘    │
└──────────────────────────┬──────────────────────────────────┘
                           │
        ┌──────────────────┼──────────────────┐
        │                  │                  │
        ▼                  ▼                  ▼
┌──────────────┐  ┌──────────────┐  ┌──────────────┐
│  PostgreSQL  │  │    Redis     │  │   Celery     │
│  + PostGIS   │  │   (Broker)   │  │   Workers    │
└──────────────┘  └──────────────┘  └──────────────┘
```

## Компоненты системы

### 1. Django Web Application

Основное веб-приложение на Django, предоставляющее:
- REST API через Django REST Framework
- Административную панель
- Обработку статических и медиа-файлов

**Основные модули:**
- `web_gis_project/` — главный проект Django
- `pdre_calculation/` — приложение для расчета ПДРЕ
- `carbon_tracker/` — приложение для отслеживания углерода (заготовка)
- `fleet/` — приложение для управления флотом (заготовка)

### 2. База данных (PostgreSQL + PostGIS)

Хранит:
- Пространственные данные (границы ООПТ, туристские объекты)
- Растровые данные (DEM, NDVI и т.д.)
- Результаты расчетов
- Метаданные и конфигурацию

**Расширения PostGIS:**
- `postgis` — базовая поддержка геоданных
- `postgis_raster` — поддержка растровых данных

### 3. Redis

Используется как:
- Брокер сообщений для Celery
- Кэш для Django (опционально)

### 4. Celery Workers

Асинхронная обработка задач:
- Расчет ПДРЕ для больших территорий
- Импорт данных из внешних источников
- Генерация отчетов и визуализаций
- Расчет пространственных параметров

### 5. Celery Beat

Планировщик периодических задач:
- Автоматический пересчет ПДРЕ
- Обновление данных из внешних источников
- Очистка старых данных

## Структура приложения pdre_calculation

### Модели данных

```
ProtectedArea (ООПТ)
    ├── TourismObject (Туристские объекты)
    ├── PDREParameter (Параметры территории)
    ├── CalculationResult (Результаты расчетов)
    └── TourismPassport (Паспорт территории)

LimitingFactor (Лимитирующие факторы)
    └── ManyToMany -> ProtectedArea
```

### Слои приложения

#### 1. Models Layer (`models.py`)
Определяет структуру данных и связи между сущностями.

**Основные модели:**
- `ProtectedArea` — особо охраняемые природные территории
- `TourismObject` — туристские объекты (маршруты, площадки)
- `LimitingFactor` — лимитирующие факторы нагрузки
- `PDREParameter` — пространственные параметры территории
- `CalculationResult` — результаты расчетов ПДРЕ
- `TourismPassport` — паспорт территории

#### 2. Business Logic Layer

**`calculation_methods.py`** — чистая бизнес-логика расчета ПДРЕ:
- `PDREMethodology` — класс с методами расчета
- `CalculationInputs` — контейнер входных данных
- Методы расчета базовой, потенциальной и предельной емкости

**`services.py`** — сервисы для работы с внешними данными:
- `DataImportService` — импорт из OSM и GPX
- `MapVisualizationService` — генерация карт
- `ParameterCalculationService` — расчет параметров территории

#### 3. API Layer

**`views.py`** — ViewSets для REST API:
- `ProtectedAreaViewSet` — CRUD для ООПТ
- `TourismObjectViewSet` — CRUD для туристских объектов
- `LimitingFactorViewSet` — управление факторами
- `CalculationResultViewSet` — просмотр результатов
- `PDREAPIViewSet` — вспомогательные операции

**`serializers.py`** — сериализаторы DRF:
- Преобразование моделей в JSON/GeoJSON
- Валидация входных данных

**`urls.py`** — маршрутизация API

#### 4. Tasks Layer (`tasks.py`)

Celery-задачи для асинхронной обработки:
- `calculate_pdre_for_area` — расчет ПДРЕ
- `import_osm_data_task` — импорт из OSM
- `calculate_territory_parameters` — расчет параметров
- `generate_tourism_passport` — генерация паспорта

## Поток данных

### Расчет ПДРЕ

```
1. Клиент отправляет запрос на расчет
   POST /api/pdre/protected-areas/{id}/calculate_pdre/

2. ViewSet создает Celery-задачу
   calculate_pdre_for_area.delay(protected_area_id)

3. Celery Worker получает задачу из Redis

4. Worker выполняет расчет:
   - Получает ООПТ и связанные туристские объекты
   - Для каждого объекта вызывает PDREMethodology.calculate_for_object()
   - Сохраняет результаты в CalculationResult
   - Генерирует визуализацию через MapVisualizationService

5. Результат сохраняется в БД

6. Клиент может получить результат через:
   GET /api/pdre/calculation-results/{id}/
```

### Импорт данных из OSM

```
1. Клиент отправляет запрос на импорт
   POST /api/pdre/pdre/import_osm_data/

2. ViewSet создает Celery-задачу
   import_osm_data_task.delay(place_name, area_type)

3. Worker выполняет импорт:
   - DataImportService.import_protected_areas_from_osm()
   - Запрашивает данные через osmnx/Overpass API
   - Создает объекты ProtectedArea в БД

4. Результат возвращается клиенту
```

## Геоданные

### Система координат

Проект использует:
- **WGS84 (EPSG:4326)** — для хранения геоданных в БД
- **Web Mercator (EPSG:3857)** — для расчетов площадей и длин

### Типы геоданных

1. **Векторные данные:**
   - `Polygon` — границы ООПТ
   - `LineString` — маршруты
   - `Point` — точечные объекты
   - `GeometryCollection` — зоны параметров

2. **Растровые данные:**
   - `RasterField` — для хранения DEM, NDVI и других растров

### Обработка геоданных

- **GeoDjango** — для работы с геоданными в Django
- **GeoPandas** — для обработки векторных данных
- **Rasterio** — для работы с растровыми данными
- **Shapely** — для геометрических операций

## Безопасность

### Аутентификация и авторизация

- **Session Authentication** — для веб-интерфейса
- **Basic Authentication** — для API
- **IsAuthenticatedOrReadOnly** — права доступа по умолчанию

### Рекомендации для продакшена

1. Использовать токен-аутентификацию (JWT)
2. Ограничить CORS настройками
3. Использовать HTTPS
4. Настроить rate limiting
5. Валидировать все входные данные

## Масштабирование

### Горизонтальное масштабирование

1. **Django приложение:**
   - Запуск нескольких инстансов за Nginx/load balancer
   - Использование shared storage для media/static

2. **Celery Workers:**
   - Запуск нескольких воркеров для параллельной обработки
   - Настройка приоритетов задач

3. **База данных:**
   - Репликация PostgreSQL
   - Партиционирование больших таблиц
   - Использование read replicas

### Оптимизация производительности

1. **Кэширование:**
   - Redis для кэширования часто запрашиваемых данных
   - Кэширование результатов расчетов

2. **Индексы:**
   - Пространственные индексы на геометрические поля
   - Индексы на часто используемые поля фильтрации

3. **Асинхронная обработка:**
   - Все тяжелые операции через Celery
   - Использование chunked processing для больших данных

## Мониторинг и логирование

### Логирование

- Django logging для веб-приложения
- Celery logging для задач
- Логирование ошибок и исключений

### Мониторинг

Рекомендуется использовать:
- **Flower** — мониторинг Celery
- **Django Debug Toolbar** — для разработки
- **Sentry** — отслеживание ошибок
- **Prometheus + Grafana** — метрики производительности

## Развертывание

### Docker Compose (разработка)

Используется для локальной разработки и тестирования.

### Продакшен

Рекомендуемая архитектура:
- **Nginx** — веб-сервер и reverse proxy
- **Gunicorn/uWSGI** — WSGI-сервер для Django
- **PostgreSQL** — отдельный сервер БД
- **Redis** — отдельный сервер для брокера
- **Celery Workers** — отдельные серверы/контейнеры

### CI/CD

Рекомендуется настроить:
- Автоматическое тестирование
- Автоматический деплой
- Миграции БД в процессе деплоя

